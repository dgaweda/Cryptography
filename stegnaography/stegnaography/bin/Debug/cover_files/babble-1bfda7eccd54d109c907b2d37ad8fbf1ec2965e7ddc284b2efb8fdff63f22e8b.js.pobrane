define("discourse/plugins/babble/discourse/routes/admin-chat",["exports","../../discourse/lib/babble","discourse/models/topic","discourse/models/group","discourse/models/category","discourse/lib/ajax"],function(e,t,i,s,n,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Discourse.Route.extend({setupController:function(e){var o=this;t.default.disabled()||s.default.findAll().then(function(t){var s=o.paramsFor("adminChat").id,r=_.reject(t.map(function(e){return e.automatic=!1,e}),function(e){return 0==e.id});"new"===s?e.setProperties({model:i.default.create({permissions:"category"}),available:r,selected:[],categories:[]}):(0,a.ajax)("/babble/topics/"+s+".json").then(function(t){var o=i.default.create(t);o.set("permissions",t.permissions),"category"==o.get("permissions")?(o.set("category",n.default.findById(t.category_id)),e.setProperties({model:o,available:r,selected:[],categories:[o.get("category")]})):(0,a.ajax)("/babble/topics/"+s+"/groups.json").then(function(t){var i=t.topics.map(function(e){return e.automatic=!1,e});o.allowed_group_ids=_.map(i,"id"),e.setProperties({model:o,available:r,selected:i,categories:[]})})})})}})}),define("discourse/plugins/babble/discourse/routes/admin-chats",["exports","../../discourse/lib/babble","discourse/lib/ajax"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Discourse.Route.extend({setupController:function(e){(0,i.ajax)("/babble/topics.json").then(function(i){var s=i.topics.map(function(e){return t.default.buildTopic(e)});e.setProperties({model:s,disabled:t.default.disabled()})})}})}),define("discourse/plugins/babble/discourse/initializers/babble-common-init",["exports","discourse/lib/plugin-api","../lib/babble","ember-addons/ember-computed-decorators","discourse/lib/intercept-click"],function(e,t,i,s,n){"use strict";function a(e,t,i,s,n){var a={};return Object.keys(s).forEach(function(e){a[e]=s[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,s){return s(e,t,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}Object.defineProperty(e,"__esModule",{value:!0}),e.default={name:"babble-common-init",initialize:function(){(0,t.withPluginApi)("0.8.9",function(e){var t,o,r,l;e.modifyClass("controller:preferences/interface",{actions:{save:function(){this.get("saveAttrNames").push("custom_fields"),this._super()}}}),i.default.disabled()||(e.modifyClass("controller:flag",{actions:{createFlag:function(e){var t=this;return this.get("model.can_flag")?(this.send("hideModal"),this.get("model.actions_summary").findBy("id",this.get("selected.id")).act(this.get("model"),e).then(function(){t.set("model.has_flagged",!0),t.appEvents.trigger("babble-rerender")}).finally(function(){t.send("closeModal")})):this._super(e)}}}),e.modifyClass("component:user-card-contents",(t=(0,s.on)("didInsertElement"),o={listenForBabble:function(){var e=this;this.appEvents.on("babble-toggle-chat",function(){Ember.run.scheduleOnce("afterRender",function(){$(".babble-sidebar").length?($(".babble-sidebar").on("click.discourse-user-card","[data-user-card]",function(t){if(!(0,n.wantsNewWindow)(t)){e.site.isMobileDevice&&e.appEvents.trigger("babble-toggle-chat");var i=$(t.currentTarget);return e._show(i.data("user-card"),i)}}),$(".babble-sidebar").on("click.discourse-user-mention","a.mention",function(t){if(!(0,n.wantsNewWindow)(t)){var i=$(t.target);return e._show(i.text().replace(/^@/,""),i)}})):$(".babble-sidebar").off("click.discourse-user-card")})})}},a(o,"listenForBabble",[t],Object.getOwnPropertyDescriptor(o,"listenForBabble"),o),o)),e.modifyClass("component:site-header",(r=(0,s.on)("didInsertElement"),l={initialize:function(){var t=this;this.site.isMobileDevice&&(this.appEvents.on("babble-has-topics",function(){e.decorateWidget("header-icons:before",function(e){return e.attach("header-dropdown",{title:"babble.title",icon:Discourse.SiteSettings.babble_icon,iconId:"babble-icon",action:"toggleBabble",contents:function(){if(i.default.unreadCount())return this.attach("link",{action:"toggleBabble",className:"babble-unread babble-unread--header",rawLabel:i.default.unreadCount()})}})})}),e.attachWidgetAction(this.widget,"toggleBabble",function(){t.appEvents.trigger("babble-toggle-chat")}),this.appEvents.on("babble-rerender",function(){t.queueRerender()}))}},a(l,"initialize",[r],Object.getOwnPropertyDescriptor(l,"initialize"),l),l)))})}}}),define("discourse/plugins/babble/discourse/controllers/admin-chat",["exports","discourse/lib/ajax"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Controller.extend({adminChats:Ember.inject.controller(),categoryPermissions:function(){return"category"==this.get("model.permissions")}.property("model.permissions"),actions:{save:function(){var e=this.get("model"),i=this.get("adminChats.model"),s=this,n=this.get("categories")[0];s.set("disableSave",!0);var a="/babble/topics/";e.id&&(a+=e.id);var o={title:e.get("title"),allowed_group_ids:e.allowed_group_ids,permissions:e.get("permissions")};n&&(o.category_id=n.id),(0,t.ajax)(a,{type:"POST",data:{topic:o}}).then(function(t){if(t=Discourse.Topic.create(t),e.id){var n=_.map(i,"id").indexOf(e.id);Ember.set(i.objectAt(n),"title",t.title)}else i.addObject(t);s.transitionToRoute("adminChat",t.id)}).catch(function(){bootbox.alert(I18n.t("babble.admin.save_failed"))}).finally(function(){s.set("disableSave",!1)})},destroy:function(){var e=this.get("model"),i=this.get("adminChats.model"),s=this,n=bootbox;s.set("disableSave",!0),n.confirm(I18n.t("babble.admin.delete_confirm"),I18n.t("no_value"),I18n.t("yes_value"),function(a){a?(0,t.ajax)("/babble/topics/"+e.id+".json",{type:"DELETE"}).then(function(){var t=_.find(i,function(t){return t.id===e.id});i.removeObject(t),s.transitionToRoute("adminChats.index")}).catch(function(){n.alert(I18n.t("babble.admin.delete_failed"))}).finally(function(){s.set("disableSave",!1)}):s.set("disableSave",!1)})}}})}),Ember.TEMPLATES["javascripts/discourse/connectors/admin-menu/babble-admin-connector"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[7,"li"],[9],[0,"\\n  "],[4,"link-to",null,[["route"],["adminChats"]],{"statements":[[1,[29,"i18n",["babble.admin.menu_title"],null],false]],"parameters":[]},null],[0,"\\n"],[10],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/connectors/admin-menu/babble-admin-connector"}}),Ember.TEMPLATES["javascripts/discourse/connectors/below-site-header/babble-audio-file"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[23,"babble-audio-file"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/connectors/below-site-header/babble-audio-file"}}),Ember.TEMPLATES["javascripts/discourse/connectors/below-site-header/babble-sidebar-component"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[23,"babble-sidebar-component"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/connectors/below-site-header/babble-sidebar-component"}}),Ember.TEMPLATES["javascripts/discourse/connectors/below-site-header/babble-emoji-picker"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[1,[23,"babble-emoji-picker"],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/connectors/below-site-header/babble-emoji-picker"}}),Ember.TEMPLATES["javascripts/discourse/connectors/user-preferences-interface/babble-user-preferences"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[7,"label"],[11,"class","control-label"],[9],[1,[29,"i18n",["babble.preferences.title"],null],false],[10],[0,"\\n"],[1,[29,"preference-checkbox",null,[["labelKey","checked"],["babble.preferences.babble_disabled",[25,["model","custom_fields","babble_disabled"]]]]],false],[0,"\\n"],[1,[29,"preference-checkbox",null,[["labelKey","checked"],["babble.preferences.babble_sound",[25,["model","custom_fields","babble_sound"]]]]],false],[0,"\\n"],[1,[29,"preference-checkbox",null,[["labelKey","checked"],["babble.preferences.babble_open_by_default",[25,["model","custom_fields","babble_open_by_default"]]]]],false],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/discourse/connectors/user-preferences-interface/babble-user-preferences"}}),Ember.TEMPLATES["javascripts/admin/chat"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[4,"if",[[25,["model"]]],null,{"statements":[[0,"  "],[7,"form"],[11,"class","form-horizontal"],[9],[0,"\\n    "],[7,"div"],[9],[0,"\\n      "],[7,"label"],[11,"for","permissions"],[9],[1,[29,"i18n",["babble.admin.permissions"],null],false],[10],[0,"\\n      "],[7,"div"],[11,"class","permissions-option"],[9],[0,"\\n        "],[1,[29,"radio-button",null,[["value","name","selection"],["category","permissions",[25,["model","permissions"]]]]],false],[0,"\\n        "],[7,"strong"],[9],[1,[29,"i18n",["babble.admin.category"],null],false],[10],[0,"\\n      "],[10],[0,"\\n      "],[7,"div"],[11,"class","permissions-option"],[9],[0,"\\n        "],[1,[29,"radio-button",null,[["value","name","selection"],["group","permissions",[25,["model","permissions"]]]]],false],[0,"\\n        "],[7,"strong"],[9],[1,[29,"i18n",["babble.admin.groups"],null],false],[10],[0,"\\n      "],[10],[0,"\\n    "],[10],[0,"\\n\\n"],[4,"if",[[25,["categoryPermissions"]]],null,{"statements":[[0,"      "],[7,"div"],[9],[0,"\\n        "],[7,"label"],[11,"for","category"],[9],[1,[29,"i18n",["babble.admin.category_label"],null],false],[10],[0,"\\n        "],[1,[29,"category-selector",null,[["categories","single","canReceiveUpdates"],[[25,["categories"]],true,"true"]]],false],[0,"\\n      "],[10],[0,"\\n"]],"parameters":[]},{"statements":[[0,"      "],[7,"div"],[9],[0,"\\n        "],[7,"label"],[11,"for","allowed_groups"],[9],[1,[29,"i18n",["babble.admin.allowed_groups_label"],null],false],[10],[0,"\\n        "],[1,[29,"multi-select",null,[["allowAny","content","values"],[false,[25,["available"]],[25,["model","allowed_group_ids"]]]]],false],[0,"\\n      "],[10],[0,"\\n      "],[7,"div"],[9],[0,"\\n        "],[7,"label"],[11,"for","title"],[9],[1,[29,"i18n",["babble.admin.title"],null],false],[10],[0,"\\n        "],[1,[29,"input",null,[["value"],[[25,["model","title"]]]]],false],[0,"\\n      "],[10],[0,"\\n"]],"parameters":[]}],[0,"\\n    "],[7,"div"],[11,"class","buttons"],[9],[0,"\\n      "],[7,"button"],[12,"disabled",[23,"disableSave"]],[11,"class","btn btn-primary"],[9],[1,[29,"i18n",["admin.customize.save"],null],false],[3,"action",[[24,0,[]],"save"]],[10],[0,"\\n"],[4,"if",[[25,["model","id"]]],null,{"statements":[[0,"        "],[7,"button"],[11,"class","btn btn-danger"],[9],[1,[29,"d-icon",["trash-o"],null],false],[1,[29,"i18n",["admin.customize.delete"],null],false],[3,"action",[[24,0,[]],"destroy"]],[10],[0,"\\n"]],"parameters":[]},null],[0,"    "],[10],[0,"\\n  "],[10],[0,"\\n"]],"parameters":[]},{"statements":[[0,"  "],[7,"p"],[9],[1,[29,"i18n",["search.no_results"],null],false],[10],[0,"\\n"]],"parameters":[]}]],"hasEval":false}',meta:{moduleName:"javascripts/admin/chat"}}),Ember.TEMPLATES["javascripts/admin/chats"]=Ember.HTMLBars.template({id:null,block:'{"symbols":["topic"],"statements":[[4,"if",[[25,["disabled"]]],null,{"statements":[[0,"  "],[7,"div"],[11,"class","babble-admin-disabled"],[9],[1,[29,"i18n",["babble.admin.disabled"],null],false],[10],[0,"\\n"]],"parameters":[]},{"statements":[[0,"  "],[7,"div"],[11,"class","row groups"],[9],[0,"\\n    "],[7,"div"],[11,"class","content-list span6"],[9],[0,"\\n      "],[7,"h3"],[9],[1,[29,"i18n",["babble.admin.page_title"],null],false],[10],[0,"\\n"],[4,"if",[[25,["model"]]],null,{"statements":[[0,"        "],[7,"ul"],[9],[0,"\\n"],[4,"each",[[25,["model"]]],null,{"statements":[[0,"            "],[7,"li"],[9],[0,"\\n"],[4,"link-to",null,[["route","model"],["adminChat",[24,1,["id"]]]],{"statements":[[4,"if",[[24,1,["title"]]],null,{"statements":[[0,"                  "],[1,[24,1,["title"]],false],[0,"\\n"]],"parameters":[]},{"statements":[[0,"                  "],[1,[29,"category-badge-chat-list",null,[["categoryId"],[[24,1,["category_id"]]]]],false],[0,"\\n"]],"parameters":[]}]],"parameters":[]},null],[0,"            "],[10],[0,"\\n"]],"parameters":[1]},null],[0,"        "],[10],[0,"\\n"]],"parameters":[]},{"statements":[[0,"        "],[7,"p"],[9],[1,[29,"i18n",["search.no_results"],null],false],[10],[0,"\\n"]],"parameters":[]}],[0,"      "],[7,"div"],[11,"class","controls"],[9],[0,"\\n"],[4,"link-to",null,[["class","route","model"],["btn","adminChat","new"]],{"statements":[[0,"          "],[1,[29,"d-icon",["plus"],null],false],[0," "],[1,[29,"i18n",["babble.admin.new"],null],false],[0,"\\n"]],"parameters":[]},null],[0,"      "],[10],[0,"\\n    "],[10],[0,"\\n    "],[7,"div"],[11,"class","content-editor"],[9],[0,"\\n      "],[1,[23,"outlet"],false],[0,"\\n    "],[10],[0,"\\n  "],[10],[0,"\\n"]],"parameters":[]}]],"hasEval":false}',meta:{moduleName:"javascripts/admin/chats"}}),Ember.TEMPLATES["javascripts/components/babble-audio-file"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[4,"if",[[25,["loadAudio"]]],null,{"statements":[[0,"  "],[7,"audio"],[11,"id","babble-notification"],[11,"src","/babble/notification.mp3"],[9],[10],[0,"\\n"]],"parameters":[]},null]],"hasEval":false}',meta:{moduleName:"javascripts/components/babble-audio-file"}}),Ember.TEMPLATES["javascripts/components/babble-emoji-picker"]=Ember.HTMLBars.template({id:null,block:'{"symbols":[],"statements":[[7,"div"],[11,"class","babble-emoji-picker emoji-picker"],[9],[10],[0,"\\n"]],"hasEval":false}',meta:{moduleName:"javascripts/components/babble-emoji-picker"}}),define("discourse/plugins/babble/discourse/lib/chat-topic-utils",["exports","./chat-component-utils","discourse/models/post-stream"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.applyPostStream=e.setupLastReadMarker=e.teardownPresence=e.isNewDay=e.isFollowOn=e.latestPostIsMine=e.latestPostFor=e.syncWithPostStream=void 0;var s=function(e){var i=e.postStream.posts.map(function(e){return e.post_number});return e.set("firstLoadedPostNumber",_.min(i)),e.set("lastLoadedPostNumber",_.max(i)),e.set("unreadCount",n(e)),(0,t.rerender)(e)},n=function(e){return!o(e)&&e.highest_post_number>e.last_read_post_number?1:0},a=function(e){return _.max(e.postStream.posts,function(e){return e.post_number})},o=function(e){var t=a(e),i=Discourse.User.current();return!(!i||!t)&&a(e).user_id==i.id},r=function(e,t){return t&&!t.deleted_at&&!(e.self_edits>0)&&t.user_id==e.user_id&&moment(e.created_at).add(-2,"minute")<moment(t.created_at)},l=function(e,t){return t&&moment(e.created_at).date()>moment(t.created_at).date()},c=function(e){clearInterval(e.pingWhilePresent)},u=function(e){e.last_read_post_number<e.highest_post_number?e.set("lastReadMarker",e.last_read_post_number):e.set("lastReadMarker",null)},d=function(e){var t=i.default.create(e.post_stream);return t.topic=e,t.updateFromJson(e.post_stream),e.set("postStream",t),e.typing={},e.online={},e};e.syncWithPostStream=s,e.latestPostFor=a,e.latestPostIsMine=o,e.isFollowOn=r,e.isNewDay=l,e.teardownPresence=c,e.setupLastReadMarker=u,e.applyPostStream=d}),define("discourse/plugins/babble/discourse/lib/element-is-visible",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e,t){if(e&&t.length){var i=t.position().top,s=i+t.height(),n=e.position().top,a=n+e.height();return s>n&&i<=a}}}),define("discourse/plugins/babble/discourse/lib/babble",["exports","discourse/models/post","discourse/models/topic","discourse/models/user","../lib/last-visible-element","discourse/lib/text","discourse/lib/ajax","../lib/chat-element-utils","../lib/chat-topic-utils","../lib/chat-topic-iterators","../lib/chat-component-utils","../lib/chat-live-update-utils","../lib/babble-registry","discourse/lib/show-modal"],function(e,t,i,s,n,a,o,r,l,c,u,d,b,p){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({summary:{},disabled:function(){return!s.default.current()||s.default.currentProp("custom_fields.babble_disabled")||!Discourse.SiteSettings.babble_enabled},bindById:function(e,t){var i=this;return this.loadTopic(t).then(function(t){return i.bind(e,t)},console.log)},bind:function(e,t,i){var s=this;if(t)return i=i||t.last_read_post_number,this.unbind(e),t=b.default.bind(e,t),(0,l.setupLastReadMarker)(t),Ember.run.scheduleOnce("afterRender",function(){(0,d.setupLiveUpdate)(t,{"":function(e){s.buildTopic(e)},typing:function(e){s.handleTyping(t,e)},online:function(e){s.handleOnline(t,e)}}),(0,r.hasChatElements)(e.element)&&((0,r.setupScrollContainer)(t),(0,r.setupComposer)(t),(0,r.scrollToPost)(t,i,0))}),(0,u.rerender)(t),t},unbind:function(e){var t=b.default.topicForComponent(e);t&&((0,d.teardownLiveUpdate)(t,"","typing","online"),(0,r.hasChatElements)(e.element)&&(0,l.teardownPresence)(t),b.default.unbind(e))},loadTopic:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.set("loadingTopicId",e);var s=i.pm?"/pm":"",n=i.postNumber?"?near_post="+i.postNumber:"";return(0,o.ajax)("/babble/topics/"+s+"/"+e+".json"+n).then(function(e){return t.buildTopic(e)}).finally(function(){t.set("loadingTopicId",null)})},subscribeToNotifications:function(e){var t=this;s.default.current()&&(0,d.messageBus)().subscribe("/babble/notifications/"+s.default.current().id,function(i){t.handleNewPost(i.post),b.default.storeNotification(i.notification),e.initialized||t.set("summary.notificationCount",t.summary.notificationCount+1),(0,r.playNotification)(),e.appEvents.trigger("babble-rerender")})},loadBoot:function(e){var t=this;return this.set("loadingBoot",!0),(0,o.ajax)("/babble/boot.json").then(function(i){_.each(i.notifications,function(e){b.default.storeNotification(e)}),_.each(i.users,function(e){b.default.storeUser(s.default.create(e))}),_.each(i.topics,function(i){t.setupTopicListener(i,e)})}).finally(function(){e.appEvents.trigger("babble-rerender"),t.set("booted",!0),t.set("loadingBoot",!1)})},loadSummary:function(e){var t=this;return this.set("loadingSummary",!0),(0,o.ajax)("/babble/summary.json").then(function(i){t.set("summary.topicCount",i.topic_count),t.set("summary.unreadCount",i.unread_count),t.set("summary.notificationCount",i.notification_count),t.set("summary.defaultId",i.default_id),t.summary.topicCount>0&&e.appEvents.trigger("babble-has-topics")}).finally(function(){e.appEvents.trigger("babble-rerender"),t.set("loadingSummary",null)})},setupTopicListener:function(e,t){var i=this;(0,d.setupLiveUpdate)(this.buildTopic(e),{posts:function(e){i.handleNewPost(e),t.appEvents.trigger("babble-rerender")}})},unreadCount:function(){var e,t;if(this.booted?(e=this.availableTopics().reduce(function(e,t){return e+t.unreadCount},0),t=this.availableNotifications().length):(e=this.summary.unreadCount||0,t=this.summary.notificationCount||0),e+t!=0)return(t||"•").toString()},singleChannel:function(){return 1==this.summary.topicCount&&!Discourse.SiteSettings.babble_enable_pms},openByDefault:function(){return s.default.currentProp("custom_fields.babble_open_by_default")},availableTopics:function(){return b.default.allTopics()},availableUsers:function(){return b.default.allUsers()},availableNotifications:function(){return b.default.allNotifications()},notificationsFor:function(e){return this.availableNotifications().filter(function(t){return e.constructor==s.default?t.sender_id==e.id:t.topic_id==e.id})},fetchDefault:function(){return this.fetchTopic(this.summary.defaultId)},fetchTopic:function(e){return b.default.fetchTopic(e)},topicForComponent:function(e){return b.default.topicForComponent(e)},buildTopic:function(e){if(e.id){var t=i.default.create(e);return(0,l.applyPostStream)(t),(0,l.syncWithPostStream)(t),b.default.storeTopic(t)}},createPost:function(e,t){var i=this;return this.stagePost(e,t),(0,o.ajax)("/babble/topics/"+e.id+"/posts",{type:"POST",data:{raw:t}}).then(function(e){i.handleNewPost(e)})},readPost:function(e,t){return this.notificationsFor(e).map(function(e){e.post_number<=t&&b.default.removeNotification(e.id)}),(0,o.ajax)("/babble/topics/"+e.id+"/read/"+t+".json")},editPost:function(e,t){t?(e.set("editingPostId",t.id),(0,r.scrollToPost)(e,t.post_number),(0,r.setupComposer)(e)):e.set("editingPostId",null)},flagPost:function(e,i){i.get("actions_summary")?(0,p.default)("flag",{model:i,babble:!0}):(0,o.ajax)("/posts/"+i.id).then(function(e){e=t.default.munge(e),i.set("actionByName",e.actionByName),i.set("actions_summary",e.actions_summary),(0,p.default)("flag",{model:i,babble:!0})})},updatePost:function(e,t,i){var s=this;return this.editPost(e,null),e.set("loadingEditId",t.id),(0,o.ajax)("/babble/topics/"+t.topic_id+"/posts/"+t.id,{type:"POST",data:{raw:i}}).then(function(e){s.handleNewPost(e)}).finally(function(){e.set("loadingEditId",null)})},destroyPost:function(e,t){return e.set("loadingEditId",t.id),(0,o.ajax)("/babble/topics/"+t.topic_id+"/posts/"+t.id,{type:"DELETE"}).finally(function(){e.set("loadingEditId",null)})},populatePermissions:function(e){var t=s.default.current();return t&&e.user_id==t.id||(delete e.can_edit,delete e.can_flag,delete e.can_delete),_.keys(e).includes("can_edit")||(e.can_edit=t.staff||e.user_id==t.id||t.trust_level>=4),_.keys(e).includes("can_flag")||(e.can_flag=!e.user_id!=t.id&&(t.staff||t.trust_level>=1)),_.keys(e).includes("can_delete")||(e.can_delete=t.staff||e.user_id==t.id),e},handleNewPost:function(e){var i=this,a=b.default.fetchTopic(e.topic_id);if(a){delete a.typing[e.username];var o=t.default.create(this.populatePermissions(e));if(o.created_at.match(/UTC/)&&(o.created_at=moment(o.created_at.replace(" UTC","Z")).local().toString()),e.is_edit||e.is_delete)a.postStream.storePost(o),a.get("loadingEditId")==e.id&&a.set("loadingEditId",null);else{var u=(0,c.forEachTopicContainer)(a,function(e){return(0,n.default)(e.find(".babble-chat"),".babble-post","post-number")==a.lastLoadedPostNumber}).some(_.identity),d=b.default.componentsForTopic(a).length&&o.user_id!=s.default.currentProp("id");if(a.lastLoadedPostNumber<o.post_number&&a.set("lastLoadedPostNumber",o.post_number),(0,l.latestPostIsMine)(a)){var p=a.postStream.findLoadedPost(-1);p&&a.postStream.removePosts([p]),a.postStream.commitPost(o)}else a.postStream.appendPost(o);d&&(0,r.playNotification)(),u&&(0,r.scrollToPost)(a,o.post_number),(0,c.forEachTopicContainer)(a,function(e){i.ensureRead(a,e)})}return(0,l.syncWithPostStream)(a)}},handleTyping:function(e,t){t.id!=s.default.currentProp("id")&&(e.typing[t.username]={user:t,lastTyped:moment()},(0,u.rerender)(e))},handleOnline:function(e,t){t.id!=s.default.currentProp("id")&&(e.online[t.username]={user:t,lastSeen:moment()},(0,u.rerender)(e))},ensureRead:function(e,t){var i=this;Ember.run.scheduleOnce("afterRender",function(){var s=(0,n.default)(t.find(".babble-chat"),".babble-post","post-number");s<=e.last_read_post_number||(e.set("last_read_post_number",s),(0,l.syncWithPostStream)(e),i.readPost(e,s))})},loadPosts:function(e,i){e.set("loadingPosts",i),(0,u.rerender)(e);var s="desc"===i?"firstLoadedPostNumber":"lastLoadedPostNumber",n=e.get(s);return(0,o.ajax)("/babble/topics/"+e.id+"/posts/"+n+"/"+i).then(function(i){i.posts.map(function(i){e.postStream.appendPost(t.default.create(i))}),(0,l.syncWithPostStream)(e),(0,r.scrollToPost)(e,e.get(s))}).finally(function(){e.set("loadingPosts",null)})},stagePost:function(e,i){var n=s.default.current();(0,a.cookAsync)(i).then(function(s){var a=t.default.create({raw:i,cooked:s.string,name:n.get("name"),display_username:n.get("name"),username:n.get("username"),user_id:n.get("id"),user_title:n.get("title"),avatar_template:n.get("avatar_template"),user_custom_fields:n.get("custom_fields"),moderator:n.get("moderator"),admin:n.get("admin"),created_at:moment()});e.postStream.set("loadedAllPosts",!0),e.postStream.stagePost(a,n),e.set("lastLoadedPostNumber",a.post_number),(0,r.scrollToPost)(e,a.post_number),(0,r.teardownComposer)(e),(0,u.rerender)(e)})}})}),define("discourse/plugins/babble/discourse/lib/chat-component-utils",["exports","./chat-topic-iterators"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.rerender=void 0;var i=function(e){return(0,t.forEachTopicComponent)(e,function(e){e.queueRerender?e.queueRerender():e.rerender()}),e};e.rerender=i}),define("discourse/plugins/babble/discourse/lib/babble-registry",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=function(){function e(e,t){var i=[],s=!0,n=!1,a=void 0;try{for(var o,r=e[Symbol.iterator]();!(s=(o=r.next()).done)&&(i.push(o.value),!t||i.length!==t);s=!0);}catch(e){n=!0,a=e}finally{try{!s&&r.return&&r.return()}finally{if(n)throw a}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();e.default=Ember.Object.create({_topics:{},_components:{},_users:{},_notifications:{},_bindings:[],bind:function(e,t){return this._bindings.push([this.store(t,"_topics","id").id,this.store(e,"_components","elementId").elementId]),this.topicForComponent(e)},unbind:function(e){var i=_.find(this._bindings,function(i){var s=t(i,2);s[0];return s[1]==e.elementId});this._bindings=_.without(this._bindings,i)},store:function(e,t,i){return!(arguments.length>3&&void 0!==arguments[3]&&arguments[3])&&this[t][e[i]]||(this[t][e[i]]=e),this[t][e[i]]},storeTopic:function(e){return this.store(e,"_topics","id",!0),this.fetchTopic(e.id)},storeUser:function(e){return this.store(e,"_users","id",!0),this.fetchUser(e.id)},storeNotification:function(e){return this.store(e,"_notifications","id"),this.fetchNotification(e.id)},fetchTopic:function(e){return this._topics[e]},fetchUser:function(e){return this._users[e]},fetchNotification:function(e){return this._notifications[e]},allTopics:function(){return _.values(this._topics)},allUsers:function(){return _.values(this._users)},allNotifications:function(){return _.values(this._notifications)},removeNotification:function(e){delete this._notifications[e]},componentsForTopic:function(e){var i=_.filter(this._bindings,function(i){var s=t(i,2),n=s[0];s[1];return n==e.id}).map(function(e){return e[1]});return _.values(_.pick(this._components,i))},topicForComponent:function(e){var i=_.find(this._bindings,function(i){var s=t(i,2);s[0];return s[1]==e.elementId})||[],s=t(i,2),n=s[0];s[1];return this._topics[n]}})}),define("discourse/plugins/babble/discourse/lib/chat-topic-iterators",["exports","./babble-registry"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.forEachTopicComponent=e.forEachTopicContainer=void 0;var i=function(e,i){return t.default.componentsForTopic(e).map(i)},s=function(e,t){return i(e,function(e){return t($(e.element))})};e.forEachTopicContainer=s,e.forEachTopicComponent=i}),define("discourse/plugins/babble/discourse/lib/chat-live-update-utils",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var t=function(e){return Discourse.__container__.lookup(e)},i=function(){return t("message-bus:main")},s=function(e,t){return"/babble/topics/"+e.id+"/"+t},n=function(e,t){_.each(t,function(t,n){i().subscribe(s(e,n),t)})},a=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),a=1;a<t;a++)n[a-1]=arguments[a];_.each(n,function(t){i().unsubscribe(s(e,t))})};e.setupLiveUpdate=n,e.teardownLiveUpdate=a,e.messageBus=i}),define("discourse/plugins/babble/discourse/lib/reopen-widget",["exports","discourse/widgets/widget"],function(e,t){"use strict";function i(e,i){var s=(0,t.queryRegistry)(e);return s?(Object.keys(i).forEach(function(e){return s.prototype[e]=i[e]}),s):void console.error("Could not find widget "+e+" in registry")}Object.defineProperty(e,"__esModule",{value:!0}),e.default=i}),define("discourse/plugins/babble/discourse/lib/last-visible-element",["exports","./element-is-visible"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e,i,s){if(e)return _.max(e.find(i).map(function(i,n){var a=$(n);if((0,t.default)(e,a))return a.data(s)}))}}),define("discourse/plugins/babble/discourse/lib/chat-element-utils",["exports","./chat-topic-iterators","discourse/lib/user-search","pretty-text/emoji/data","pretty-text/emoji","discourse/lib/text","discourse/lib/raw-templates","discourse/lib/debounce","discourse/lib/autosize","discourse/models/user","discourse/models/site","../lib/babble"],function(e,t,i,s,n,a,o,r,l,c,u,d){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.playNotification=e.setupChannelAutocomplete=e.positionDropdown=e.hasChatElements=e.teardownComposer=e.setupComposer=e.setupScrollContainer=e.scrollToPost=void 0;var b=function(e,i){var s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:400,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:60;Ember.run.scheduleOnce("afterRender",function(){(0,t.forEachTopicContainer)(e,function(e){if(m(e)){var t=e.find(".babble-list"),a=e.find(".babble-post[data-post-number="+i+"]");if(a.length&&t.length){var o=a.find(".babble-post-content-wrapper").width();t.find(".babble-post-content img[height]").toArray().map(function(e){var t,i=parseInt(e.attributes.height.value),s=parseInt(e.attributes.width.value);t=i<=o&&s<=o?i:o*i/s,e.style.height=t+"px"});var r=a.position().top+t.scrollTop()-n;t.animate({scrollTop:r},s)}}})})},p=function(e){(0,t.forEachTopicContainer)(e,function(t){if(m(t)){var i=$(t).find(".babble-list[scroll-container=inactive]");return i.length?($(i).on("scroll.discourse-babble-scroll",(0,r.default)(function(){t.find(".babble-post-actions-menu").hide(),d.default.ensureRead(e,t)},500)),d.default.ensureRead(e,t),t.attr("scroll-container","active"),t):void console.warn("Babble scroll container already active or could not be found")}})},f=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{emojis:!0,mentions:!0};Ember.run.scheduleOnce("afterRender",function(){(0,t.forEachTopicContainer)(e,function(t){if(m(t)){var d=$(t).find(".babble-post-composer textarea[babble-composer=inactive]");if(!d.length)return void console.warn("Babble composer already active or could not be found");(0,l.default)(d),r.emojis&&d.autocomplete({template:(0,o.findRawTemplate)("emoji-selector-autocomplete"),key:":",transformComplete:function(e){if(e.code)return e.code+":"},dataSource:function(e){return new Ember.RSVP.Promise(function(t){return t(""===e&&["smile","smiley","wink","sunny","blush"]||s.translations[":"+e]||(0,n.emojiSearch)(e,{maxResults:5}))}).then(function(e){return _.flatten([e]).map(function(e){return{code:e,src:(0,a.emojiUrlFor)(e)}})})}}),r.mentions&&(d.autocomplete({template:(0,o.findRawTemplate)("user-selector-autocomplete"),key:"@",dataSource:function(t){return(0,i.default)({term:t,topicId:e.id,includeGroups:!0,exclude:[c.default.currentProp("username")]})},transformComplete:function(e){return e.username||e.name}}),d.attr("babble-composer","active"),u.default.current().isMobileDevice||d.focus())}})})},h=function(e){(0,t.forEachTopicContainer)(e,function(e){if(m(e)){var t=$(e).find(".babble-post-composer textarea[babble-composer=active]")[0],i=document.createEvent("Event");i.initEvent("autosize:update",!0,!1),t.dispatchEvent(i)}})},m=function(e){return $(e).find(".babble-chat").length},g=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:150,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:100,n=document.elementFromPoint(e.clientX,e.clientY).closest(".btn").getBoundingClientRect();setTimeout(function(){var e=document.querySelector(t);e.style.top=n.top+"px",document.body.offsetWidth>n.left+i?e.style.left=n.left+"px":e.style.right=document.body.offsetWidth-n.right+"px"},s)},v=function(){
var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};setTimeout(function(){var t=$(document.querySelector(".babble-"+e.type+"-autocomplete input"));t.autocomplete({template:(0,o.findRawTemplate)(e.template),onChangeItems:function(t){e.onSelect(t[0])},dataSource:e.source}),t.focus()},100)},y=function(){var e=$("audio#babble-notification")[0];e&&e.play&&e.play()};e.scrollToPost=b,e.setupScrollContainer=p,e.setupComposer=f,e.teardownComposer=h,e.hasChatElements=m,e.positionDropdown=g,e.setupChannelAutocomplete=v,e.playNotification=y}),define("discourse/plugins/babble/discourse/components/babble-sidebar-component",["exports","discourse/components/mount-widget","../lib/babble","ember-addons/ember-computed-decorators"],function(e,t,i,s){"use strict";function n(e,t,i,s,n){var a={};return Object.keys(s).forEach(function(e){a[e]=s[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,s){return s(e,t,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}Object.defineProperty(e,"__esModule",{value:!0});var a,o,r,l,c;Discourse.SiteSettings.whos_online_enabled&&(c=Ember.inject.service("online-service")),e.default=t.default.extend((a=(0,s.on)("didInsertElement"),o=(0,s.on)("willDestroyElement"),r=(0,s.observes)("visible"),l={widget:"babble-sidebar",availableTopics:[],availableUsers:[],whosOnline:c,buildArgs:function(){var e=this;return i.default.disabled()?{}:{topic:this.topic,mobile:this.site.isMobileDevice,initialized:this.initialized,canInitialize:Discourse.SiteSettings.babble_enable_pms||i.default.summary.topicCount>0,availableTopics:i.default.availableTopics(),availableUsers:i.default.availableUsers(),visible:this.initialized&&this.visible,csrf:this.session.get("csrfToken"),isOnline:function(t){if(e.get("whosOnline"))return e.get("whosOnline").isUserOnline(t)}}},_initialize:function(){var e=this;i.default.disabled()||(this.set("targetObject",this),$(window).on("resize.babble-window-resize",_.debounce(function(){e.appEvents.trigger("babble-rerender")},250)),Discourse.SiteSettings.babble_adaptive_height&&$(window).on("scroll.babble-scroll",_.throttle(function(){e.appEvents.trigger("babble-rerender")},250)),this.appEvents.on("babble-toggle-chat",function(){e.visible?e.closeChat():e.openChat()}),this.appEvents.on("babble-rerender",function(){e.dirtyKeys.forceAll(),e.rerenderWidget()}),this.appEvents.on("babble-has-topics",function(){i.default.openByDefault()&&!e.site.isMobileDevice&&e.initialize()}),i.default.subscribeToNotifications(this),i.default.loadSummary(this))},_teardown:function(){$(window).off("resize.babble-window-resize"),$(window).off("scroll.babble-scroll"),this.appEvents.off("babble-toggle-chat"),this.appEvents.off("babble-rerender")},_updateOutletClass:function(){var e=$("#main-outlet");this.visible?e.addClass("chat-active--"+Discourse.SiteSettings.babble_position):e.removeClass("chat-active--"+Discourse.SiteSettings.babble_position),this.appEvents.trigger("babble-rerender")},initialize:function(e){var t=this;this.initialized||(this.set("initialized",!0),i.default.loadBoot(this).then(function(){t.openChat(e)}))},openChat:function(e){var t=this;if(!this.initialized)return this.initialize(e);if(!e&&i.default.singleChannel()){if(this.defaultLoaded)return this.openChat(i.default.fetchDefault());i.default.loadTopic(i.default.summary.defaultId).then(function(){t.set("defaultLoaded",!0),t.openChat()})}else this.visible&&this.closeChat(),i.default.bind(this,e),this.set("topic",e),this.set("visible",!0)},closeChat:function(){this.set("visible",!1),i.default.unbind(this)},channelView:function(){i.default.unbind(this)}},n(l,"_initialize",[a],Object.getOwnPropertyDescriptor(l,"_initialize"),l),n(l,"_teardown",[o],Object.getOwnPropertyDescriptor(l,"_teardown"),l),n(l,"_updateOutletClass",[r],Object.getOwnPropertyDescriptor(l,"_updateOutletClass"),l),l))}),define("discourse/plugins/babble/discourse/components/babble-audio-file",["exports","discourse/models/user","../lib/babble"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Component.extend({loadAudio:!i.default.disabled()&&t.default.currentProp("custom_fields.babble_sound")})}),define("discourse/plugins/babble/discourse/components/babble-emoji-picker",["exports","discourse/components/emoji-picker","ember-addons/ember-computed-decorators"],function(e,t,i){"use strict";function s(e,t,i,s,n){var a={};return Object.keys(s).forEach(function(e){a[e]=s[e]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce(function(i,s){return s(e,t,i)||i},a),n&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(n):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}Object.defineProperty(e,"__esModule",{value:!0});var n,a,o;e.default=t.default.extend((n=(0,i.on)("didInsertElement"),a=(0,i.on)("willDestroyElement"),o={automaticPositioning:!1,listenForBabble:function(){var e=this;this.appEvents.on("babble-emoji-picker:open",function(t){e.set("active",!0),e.show()}),this.appEvents.on("babble-emoji-picker:close",function(){e.close(),e.set("active",!1)}),$("html").on("keydown.babble-emoji-picker",function(t){27==t.which&&e.appEvents.trigger("babble-emoji-picker:close")}),$("html").on("click.babble-emoji-picker",function(t){$(t.target).closest(".babble-emoji-picker").length||e.appEvents.trigger("babble-emoji-picker:close")})},cleanupBabble:function(){this.appEvents.off("babble-emoji-picker:open"),this.appEvents.off("babble-emoji-picker:close"),$("html").off("keydown.babble-emoji-picker"),$("html").off("click.babble-emoji-picker")},emojiSelected:function(e){var t=$(".babble-composer-wrapper textarea");t.val(t.val()+" :"+e+":"),Discourse.__container__.lookup("app-events:main").trigger("babble-emoji-picker:close")}},s(o,"listenForBabble",[n],Object.getOwnPropertyDescriptor(o,"listenForBabble"),o),s(o,"cleanupBabble",[a],Object.getOwnPropertyDescriptor(o,"cleanupBabble"),o),o))}),define("discourse/plugins/babble/discourse/babble-admin-route-map",["exports"],function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default={resource:"admin",map:function(){this.route("adminChats",{path:"/chats",resetNamespace:!0},function(){this.route("adminChat",{path:"/:id",resetNamespace:!0})})}}}),define("discourse/plugins/babble/discourse/widgets/babble-post",["exports","discourse/widgets/widget","../widgets/templates/babble-post","discourse/models/user"],function(e,t,i,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-post",{tagName:"li.babble-post",shadowTree:!0,buildKey:function(e){return"babble-post-"+e.post.id},buildAttributes:function(){var e=this.state.post,t={"data-post-id":e.id,"data-user-id":e.user_id,"data-post-number":e.post_number};return e.user_id==s.default.currentProp("id")&&(t["data-my-post"]=!0),t},defaultState:function(e){return{post:e.post,topic:e.topic,isFollowOn:e.isFollowOn,isNewDay:e.isNewDay,editedRaw:e.post.raw}},html:function(){return i.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-channels",["exports","discourse/widgets/widget","../widgets/templates/babble-channels","../lib/babble","discourse/lib/user-search","../lib/chat-element-utils"],function(e,t,i,s,n,a){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-channels",{tagName:"div.babble-channels",buildKey:function(e){return"babbleChannels"},defaultState:function(e){return{search:{}}},changeTopic:function(e){var t=this;s.default.loadTopic(e.id,{pm:e.constructor==Discourse.User}).then(function(e){t.sendWidgetAction("open",e)},console.log)},pmsSearch:function(){var e=this;this.state.search.pms=!0,(0,a.setupChannelAutocomplete)({type:"pms",template:"user-selector-autocomplete",onSelect:function(t){e.changeTopic(Discourse.User.create({id:t.username}))},source:function(e){return(0,n.default)({term:e,exclude:["discobot","system",Discourse.User.current().get("username")]})}})},html:function(){return i.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-post-actions",["exports","discourse/widgets/widget","../lib/babble","../widgets/templates/babble-post-actions","../lib/chat-element-utils"],function(e,t,i,s,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-post-actions",{buildKey:function(e){return"babble-post-actions-"+e.post.id},defaultState:function(e){return{topic:e.topic,post:e.post,open:!1}},open:function(e){(0,n.positionDropdown)(e,".babble-post-actions-menu"),this.state.open=!0,this.scheduleRerender()},edit:function(){i.default.editPost(this.state.topic,this.state.post)},flag:function(){i.default.flagPost(this.state.topic,this.state.post)},delete:function(){i.default.destroyPost(this.state.topic,this.state.post)},clickOutside:function(){this.state.open&&(this.state.open=!1,this.scheduleRerender())},html:function(){return s.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-sidebar",["exports","discourse/widgets/widget","../widgets/templates/babble-sidebar"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-sidebar",{tagName:"div.babble-sidebar-wrapper",buildKey:function(e){return e.topic?"babbleSidebar"+e.topic.id:"babbleSidebar"},defaultState:function(e){return{view:e.topic?"chat":"channels"}},html:function(){return i.default.render(this)},expandChat:function(){var e=this;this.state.expanded=!0,Ember.run.scheduleOnce("afterRender",this,function(){e.scheduleRerender()})},compressChat:function(){var e=this;this.state.expanded=!1,Ember.run.scheduleOnce("afterRender",this,function(){e.scheduleRerender()})},open:function(e,t){this.state.view="chat",this.sendWidgetAction("openChat",e,t)},viewChannels:function(){this.state.view="channels",this.sendWidgetAction("channelView")}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-post",["exports","virtual-dom","discourse/widgets/raw-html","discourse/lib/formatter","discourse/widgets/post","discourse/lib/text","discourse-common/lib/icon-library"],function(e,t,i,s,n,a,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){return this.widget=e,this.post=e.state.post,this.topic=e.state.topic,this.isFollowOn=e.state.isFollowOn,this.isNewDay=e.state.isNewDay,this.staged=this.topic.get("loadingEditId")===this.post.id||-1==this.post.id,this.editing=this.topic.get("editingPostId")===this.post.id,this.post.set("usernameUrl",e.state.post.get("usernameUrl")),this.container()},container:function(){var e="div.babble-post-container";return this.isFollowOn&&(e+=".babble-follow-on"),[this.daySeparator(),(0,t.h)(e,this.contents()),this.unreadLine()]},contents:function(){return[(0,t.h)("a.babble-avatar-wrapper",{attributes:{"data-user-card":this.post.username,href:"/u/"+this.post.username}},this.avatar()),(0,t.h)("div.babble-post-content-wrapper",[this.title(),this.body()])]},body:function(){return this.post.deleted_at?(0,t.h)("div.babble-staged-post.babble-deleted-post",I18n.t("babble.post_deleted_by",{username:this.post.deleted_by_username})):this.post.user_deleted?(0,t.h)("div.babble-staged-post.babble-deleted-post",this.cooked()):this.topic.get("editingPostId")===this.post.id?this.widget.attach("babble-composer",{post:this.post,topic:this.topic,isEditing:!0,raw:this.post.raw}):this.staged?(0,t.h)("div.babble-staged-post",this.cooked()):(0,t.h)("div.babble-post-content",this.cooked())},avatar:function(){return this.isFollowOn?(0,t.h)("div.babble-avatar-placeholder"):this.post.user_id?(0,n.avatarImg)("medium",{template:this.post.avatar_template,username:this.post.username}):(0,o.iconNode)("trash-o",{class:"deleted-user-avatar"})},postName:function(){return(0,t.h)("div.babble-post-name",this.widget.attach("poster-name",this.post))},postDate:function(){return(0,t.h)("div.babble-post-date",(0,s.relativeAge)(new Date(this.post.created_at)))},postEdited:function(){if(this.post.self_edits>0)return(0,t.h)("div.babble-post-explainer",I18n.t("babble.post_edited"))},postFlagged:function(){if(this.post.has_flagged)return(0,t.h)("div.babble-post-explainer","("+I18n.t("babble.flagged").toLowerCase()+")")},title:function(){return this.isFollowOn?(0,t.h)("div.babble-post-meta-data",this.actions()):(0,t.h)("div.babble-post-meta-data",[this.postName(),this.postDate(),this.postFlagged(),this.postEdited(),this.actions()])},cooked:function(){return new i.default({html:'<div class="babble-post-cooked">'+(0,a.emojiUnescape)(this.post.cooked)+"</div>"})},daySeparator:function(){if(this.isNewDay){var e=moment(new Date(this.post.created_at)).startOf("day").calendar({lastWeek:"dddd"}).replace("at 12:00 AM","");return(0,t.h)("div.babble-post-new-day-message.babble-post-hr-message",(0,t.h)("span",e))}},unreadLine:function(){if(this.post.post_number==this.topic.lastReadMarker)return(0,t.h)("div.babble-last-read.babble-post-hr-message",(0,t.h)("span",I18n.t("babble.new_messages")))},actions:function(){if(!this.editing&&!this.post.deleted_at)return this.staged?this.loadingSpinner():this.widget.attach("babble-post-actions",{topic:this.topic,post:this.post})},loadingSpinner:function(){return(0,t.h)("div.spinner-container",(0,t.h)("div.spinner"))}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-channels",["exports","virtual-dom","discourse/widgets/post","discourse-common/lib/icon-library","../../lib/babble"],function(e,t,i,s,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){return this.widget=e,this.availableTopics=e.attrs.availableTopics||[],this.availableUsers=e.attrs.availableUsers||[],[this.topicsHeader(),this.topicsList()]},topicsHeader:function(){return(0,t.h)("div.babble-title-wrapper",(0,t.h)("div.babble-title",this.topicsHeaderContent()))},topicsHeaderContent:function(){return[this.topicsHeaderIcon(),this.topicsHeaderText(),this.closeButton()]},closeButton:function(){return(0,t.h)("div.babble-context-toggle",this.widget.attach("button",{className:"normalized",icon:"close",action:"closeChat",title:"babble.close_chat"}))},searchButton:function(e){if(!this.widget.state.search[e])return this.widget.attach("button",{icon:"search",className:"normalized",action:e+"Search"})},searchAutocomplete:function(e){if(this.widget.state.search[e])return(0,t.h)("div.babble-"+e+"-autocomplete",(0,t.h)("input",{placeholder:I18n.t("babble."+e+"_autocomplete")}))},topicsHeaderIcon:function(){var e=Discourse.SiteSettings.babble_icon;return(0,s.iconNode)(e,{class:"babble-title-icon"})},topicsHeaderText:function(){return(0,t.h)("h4.babble-topic-switcher-title",I18n.t("babble.select_topic"))},topicsList:function(){return(0,t.h)("div.babble-list",(0,t.h)("ul.babble-available-topics",[this.availableCategories(),this.availableGroups(),this.availablePMs()]))},availableCategories:function(){var e=this,i=this.availableTopics.filter(function(e){return"category"==e.permissions});if(i.length)return _.flatten([(0,t.h)("h5.babble-topic-section-header",I18n.t("babble.categories_title")),i.map(function(t){return e.availableTopicListItem(t,"category")})])},availableGroups:function(){var e=this,i=this.availableTopics.filter(function(e){return"group"==e.permissions});if(i.length)return _.flatten([(0,t.h)("h5.babble-topic-section-header",I18n.t("babble.groups_title")),i.map(function(t){return e.availableTopicListItem(t,"group")})])},availablePMs:function(){var e=this,i=_.sortBy(this.availableUsers,function(e){return e.last_posted_at||""}).reverse();if(i.length)return _.compact(_.flatten([(0,t.h)(".babble-topic-section-header-wrapper",_.compact([(0,t.h)("h5.babble-topic-section-header",I18n.t("babble.pms_title")),this.searchButton("pms")])),this.searchAutocomplete("pms"),i.map(function(t){return e.availableTopicListItem(t,"user")})]))},availableTopicListItem:function(e,i){var s=e.unreadCount?".unread":"";return(0,t.h)("li.babble-available-topic.row"+s,[this.availableTopicAvatar(e,i),this.availableTopicLink(e,i),this.notificationCounter(e),this.loadingSpinner(n.default.loadingTopicId===e.id)])},availableTopicAvatar:function(e,s){switch(s){case"category":return(0,t.h)("span.babble-topic-avatar",{style:{"background-color":"#"+e.category.color}});case"group":return(0,t.h)("img.babble-topic-avatar",{src:Discourse.getURL("/images/avatar.png")});case"user":var n=this.widget.attrs.isOnline(e.id)?".user-online":"";return(0,t.h)("span.babble-topic-avatar.topic-avatar"+n,(0,i.avatarImg)("small",{template:e.avatar_template,username:e.username}))}},availableTopicLink:function(e,t){return this.widget.attach("link",{rawLabel:"user"==t?e.name||e.username:e.title,action:"changeTopic",actionParam:e})},notificationCounter:function(e){if(n.default.loadingTopicId!=e.id){var i=n.default.notificationsFor(e).length;return i>0?(0,t.h)("div.babble-unread",i.toString()):void 0}},loadingSpinner:function(e){if(e)return(0,t.h)("div.spinner-container",(0,t.h)("div.spinner"))}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-post-actions",["exports","virtual-dom","discourse-common/lib/icon-library"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){if(this.widget=e,this.post=e.state.post,this.topic=e.state.topic,!this.post.deleted_at&&_.compact(this.actions()).length){var i=this.widget.state.open?".opened":".closed";return(0,t.h)("div.babble-post-actions"+i,[this.dropdown(),this.button()])}},button:function(){return this.widget.attach("button",{icon:"ellipsis-h",action:"open",className:"btn normalized babble-post-actions-ellipsis",sendActionEvent:!0})},dropdown:function(){if(this.widget.state.open)return(0,t.h)("div.babble-post-actions-menu",this.actions())},actions:function(){return[this.edit(),this.flag(),this.delete()]},edit:function(){if(this.post.can_edit)return this.widget.attach("link",{className:"btn",icon:"pencil",action:"edit",label:"post.controls.edit_action"})},flag:function(){if(this.post.can_flag)return this.post.has_flagged?(0,t.h)("div.widget-link.babble-link-disabled.btn",[(0,i.iconNode)("flag"),I18n.t("babble.flagged")]):this.widget.attach("link",{className:"btn",icon:"flag",action:"flag",label:"post.actions.flag"})},delete:function(){if(this.post.can_delete)return this.widget.attach("link",{className:"btn",icon:"trash-o",action:"delete",label:"user.admin_delete"})}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-sidebar",["exports","virtual-dom","../../lib/babble"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){if(this.widget=e,e.attrs.canInitialize)return e.attrs.visible?this.expanded():this.collapsed()},expanded:function(){this.widget.attrs.expanded=this.widget.state.expanded;var e=".babble-sidebar--"+Discourse.SiteSettings.babble_position;return(0,t.h)("div.babble-sidebar"+e+this.css(),this.attrs(),[this.channels(),this.chat()])},collapsed:function(){return(0,t.h)("div.btn.babble-sidebar-collapsed.babble-sidebar-collapsed--"+Discourse.SiteSettings.babble_position+this.css(),[this.collapsedIcon(),this.collapsedUnread()])},channels:function(){return"channels"!=this.widget.state.view?null:this.widget.attach("babble-channels",this.widget.attrs)},chat:function(){return"chat"!=this.widget.state.view?null:this.widget.attach("babble-chat",this.widget.attrs)},collapsedIcon:function(){return i.default.loadingTopics?(0,t.h)("div.spinner-container",(0,t.h)("div.spinner")):this.widget.attach("button",{icon:Discourse.SiteSettings.babble_icon,action:"openChat"})},collapsedUnread:function(){return(0,t.h)("div.babble-unread.babble-unread--sidebar",i.default.unreadCount())},attrs:function(){if(this.widget.attrs.mobile||!Discourse.SiteSettings.babble_adaptive_height||!this.widget.attrs.visible)return{};var e=$(".d-header")[0],t=e.getBoundingClientRect().bottom;return{style:"height: "+($(window).height()-t)+"px;"}},css:function(){var e="";return(this.widget.state.expanded||this.widget.attrs.mobile)&&(e+=".expanded"),this.widget.attrs.mobile&&(e+=".mobile"),e}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-typing",["exports","virtual-dom"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){return this.widget=e,(0,t.h)("div.babble-typing.clearfix",this.typingSentence(e.state.topic.typing))},typingSentence:function(e){var t=this,i=_.filter(_.keys(e),function(t){return e[t].lastTyped>moment().add(-1,"second")});if(i.length)switch(setTimeout(function(){t.widget.scheduleRerender()},2e3),i.length){case 1:return I18n.t("babble.typing.single",{first:i[0]});case 2:return I18n.t("babble.typing.double",{first:i[0],second:i[1]});case 3:return I18n.t("babble.typing.several")}}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-composer",["exports","virtual-dom"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){return this.widget=e,this.state=e.state,Discourse.User.current()?this.composer():this.loggedOutView()},composer:function(){return(0,t.h)("div.babble-composer-wrapper",[this.textarea(),this.actions()])},actions:function(){return(0,t.h)("div.babble-composer-actions",[this.uploadButton(),this.uploadFile(),this.emojiButton()])},textarea:function(){return(0,t.h)("textarea",{attributes:{"babble-composer":"inactive",placeholder:Discourse.SiteSettings.babble_placeholder||I18n.t("babble.placeholder"),rows:1,disabled:this.state.submitDisabled}},this.state.raw)},uploadFile:function(){return(0,t.h)("input#babble-file-input",{type:"file"})},uploadButton:function(){if(!this.state.editing)return this.widget.attach("button",{className:"babble-composer-action upload-button",icon:"paperclip",action:"uploadFile",sendActionEvent:!0})},emojiButton:function(){return this.widget.attach("button",{className:"babble-composer-action emoji-button",icon:"smile-o",action:"selectEmoji"})},loggedOutView:function(){return[(0,t.h)("div.babble-logged-out-message",I18n.t("babble.logged_out")),this.widget.attach("header-buttons",{canSignUp:this.widget.attrs.canSignUp,showLogin:null,showSignUp:null})]}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-online",["exports","virtual-dom"],function(e,t){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){return this.widget=e,(0,t.h)("div.babble-online.clearfix",this.whosOnline(e.state.topic.online))},whosOnline:function(e){var t=_.compact(_.map(_.filter(_.keys(e),function(t){return e[t].lastSeen>moment().add(-1,"minute")}),"user"));return _.map(t,"username")}})}),define("discourse/plugins/babble/discourse/widgets/templates/babble-chat",["exports","virtual-dom","../../lib/chat-topic-utils"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=Ember.Object.create({render:function(e){if(this.widget=e,this.topic=this.widget.attrs.topic,this.availableTopics=this.widget.attrs.availableTopics||[],this.csrf=this.widget.state.csrf,this.topic)return this.chatContents()},chatContents:function(){var e=[(0,t.h)("div.babble-list",{attributes:{"scroll-container":"inactive"}},[this.pressurePlate("desc"),(0,t.h)("ul",{className:"babble-posts"},this.chatView()),this.pressurePlate("asc")]),this.widget.attach("babble-typing",{topic:this.topic}),this.widget.attach("babble-composer",{topic:this.topic,csrf:this.csrf})];return this.widget.attrs.fullpage||e.unshift((0,t.h)("div.babble-title-wrapper",(0,t.h)("div.babble-title",[this.switchTopicsButton(),this.chatTitle(),this.modifySizeButton(),this.closeButton()]))),e},pressurePlate:function(e){if(this.topic.postStream.posts.length&&("asc"!==e||this.topic.highest_post_number!=this.topic.lastLoadedPostNumber))return(0,t.h)("div.babble-post-hr-message",this.pressurePlateMessage(e))},pressurePlateMessage:function(e){var i,s;switch(e){case"desc":s="loadPostsBackward",i=this.topic.firstLoadedPostNumber>this.topic.lowest_post_number;break;case"asc":s="loadPostsForward",i=this.topic.lastLoadedPostNumber<this.topic.highest_post_number}return this.topic.loadingPosts?(0,t.h)("span.babble-load-message",I18n.t("babble.loading_messages")):i?this.widget.attach("button",{label:"babble.load_more",className:"babble-load-message babble-pressure-plate "+e,action:s}):(0,t.h)("span.babble-load-message",I18n.t("babble.no_more_messages"))},chatTitle:function(){return(0,t.h)("h4.babble-group-title",this.topic.title)},modifySizeButton:function(){if(!this.widget.attrs.mobile){var e={className:"normalized"};return this.widget.attrs.expanded?(e.icon="compress",e.action="compressChat",e.title="babble.compress_chat"):(e.icon="expand",e.action="expandChat",e.title="babble.expand_chat"),(0,t.h)("div.babble-context-toggle",this.widget.attach("button",e))}},closeButton:function(){return(0,t.h)("div.babble-context-toggle",this.widget.attach("button",{className:"normalized",icon:"close",action:"closeChat",title:"babble.close_chat"}))},switchTopicsButton:function(){if(0!=this.availableTopics.length)return(0,t.h)("div.babble-context-toggle.for-chat",this.widget.attach("button",{className:"normalized",icon:"list-ul",action:"viewChannels",title:"babble.view_topics_tooltip"}))},chatView:function(){var e=this,s=this.topic.postStream;if(s.loadingBelow)return this.loadingSpinner();if(s.posts.length){var n=s.posts.sort(function(e,t){return e.post_number-t.post_number});return n.map(function(t,s){return e.widget.attach("babble-post",{post:t,topic:e.topic,isFollowOn:(0,i.isFollowOn)(t,n[s-1]),isNewDay:(0,i.isNewDay)(t,n[s-1])})})}return(0,t.h)("li.babble-empty-topic-message",I18n.t("babble.empty_topic_message"))},loadingSpinner:function(){return(0,t.h)("div.spinner-container",(0,t.h)("div.spinner"))}})}),define("discourse/plugins/babble/discourse/widgets/babble-typing",["exports","discourse/widgets/widget","../widgets/templates/babble-typing"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-typing",{buildKey:function(e){return"babble-typing-"+e.topic.id},defaultState:function(e){return{topic:e.topic}},html:function(){return i.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-composer",["exports","discourse/widgets/widget","../lib/babble","../widgets/templates/babble-composer","discourse/lib/ajax","../lib/chat-live-update-utils","discourse/lib/utilities","discourse/models/user"],function(e,t,i,s,n,a,o,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-composer",{tagName:"div.babble-post-composer",buildKey:function(e){return"babble-composer-"+e.topic.id},defaultState:function(e){return{editing:e.isEditing,submitDisabled:e.submitDisabled,post:e.post,topic:e.topic,raw:e.raw,csrf:e.csrf}},composerElement:function(){return this.state.editing?$(".babble-post-container .babble-post-composer textarea"):$(".babble-chat > .babble-post-composer textarea")},selectEmoji:function(){this.appEvents.trigger("babble-emoji-picker:open",this.composerElement())},uploadFile:function(e){var t=this,s=$(e.target),n=$("#babble-file-input");s.fileupload({url:Discourse.getURL("/uploads.json?client_id="+(0,a.messageBus)().clientId+"&authenticity_token="+this.state.csrf),dataType:"json",pasteZone:s}),s.on("fileuploadsubmit",function(e,i){t.state.submitDisabled=!0,i.formData={type:"composer"},t.scheduleRerender()}),s.on("fileuploadprogressall",function(e,t){}),s.on("fileuploadfail",function(){t.state.submitDisabled=void 0,t.scheduleRerender()}),s.on("fileuploaddone",function(e,n){s.fileupload("destroy"),t.state.submitDisabled=void 0;var a=n.result;a&&a.url&&i.default.createPost(t.state.topic,(0,o.getUploadMarkdown)(a)),t.scheduleRerender()}),Ember.run.scheduleOnce("afterRender",function(){n.on("change",function(){s.fileupload("add",{fileInput:n}),n.off("change")}),n.click()})},cancel:function(){i.default.editPost(this.state.topic,null)},isEmptyEdit:function(){return this.composerElement().val()==this.state.post.raw.trim()},submit:function(){this.composerElement().val()&&(this.state.editing?this.update():this.create(),this.composerElement().val(""))},create:function(){var e=this,t=this.composerElement().val();this.state.submitDisabled=!0,i.default.createPost(this.state.topic,t).finally(function(){e.state.submitDisabled=void 0,Ember.run.scheduleOnce("afterRender",function(){e.composerElement().focus()})})},update:function(){var e=this,t=this.composerElement().val();this.isEmptyEdit()?this.state.topic.editingPostId=null:i.default.updatePost(this.state.topic,this.state.post,t).finally(function(){e.state.submitDisabled=void 0})},keyDown:function(e){if(13==e.keyCode&&!(e.ctrlKey||e.altKey||e.shiftKey)){if(this.state.submitDisabled)return;return e.preventDefault(),this.submit(),!1}if(27==e.keyCode)return e.preventDefault(),i.default.editPost(this.state.topic,null),!1},keyUp:function(e){if(38==e.keyCode&&!this.state.editing&&!$(e.target).siblings(".autocomplete").length){var t=_.last(_.filter(this.state.topic.postStream.posts,function(e){return e.user_id==r.default.currentProp("id")}));return t&&!e.target.value&&(i.default.editPost(this.state.topic,t),this.appEvents.trigger("babble-rerender")),!1}e.key&&1===e.key.length&&this.announceTyping()},announceTyping:_.throttle(function(){(0,n.ajax)("/babble/topics/"+this.state.topic.id+"/typing",{type:"POST"})},2e3,{leading:!0,trailing:!1}),html:function(){return s.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-online",["exports","discourse/widgets/widget","../widgets/templates/babble-online"],function(e,t,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-online",{buildKey:function(e){return"babble-online-"+e.topic.id},defaultState:function(e){return{topic:e.topic}},html:function(){return i.default.render(this)}})}),define("discourse/plugins/babble/discourse/widgets/babble-chat",["exports","discourse/widgets/widget","../widgets/templates/babble-chat","discourse/models/category","../lib/babble"],function(e,t,i,s,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=(0,t.createWidget)("babble-chat",{tagName:"div.babble-chat",buildKey:function(e){return"babbleChat"},defaultState:function(e){return{topic:e.topic,category:s.default.findById(e.topic.category_id),csrf:e.csrf}},loadPostsForward:function(){n.default.loadPosts(this.state.topic,"asc")},loadPostsBackward:function(){n.default.loadPosts(this.state.topic,"desc")},html:function(){return i.default.render(this)}})});
//# sourceMappingURL=/assets/plugins/babble-1bfda7eccd54d109c907b2d37ad8fbf1ec2965e7ddc284b2efb8fdff63f22e8b.js.map